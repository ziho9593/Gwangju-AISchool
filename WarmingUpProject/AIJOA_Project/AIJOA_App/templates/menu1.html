<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>메뉴</title>
    <link rel="stylesheet" type="text/css" href="{% static 'menu.css' %}" />
    <script src="{% static 'script.js' %}"  defer="defer" type="text/javascript"></script>
    <script src="{% static 'jquery-1.12.3.js' %}" type="text/javascript"></script>
</head>
<body>
    <section>
        <div id="slide">
            <ul>
                <div class="main">
                    <div class="item1">
                        <div class="i101">폴더버거 핫치킨</div>
                        <div class="i102"><img src="http://www.lotteria.com//Data//Goods/330/DetailImage.jpg" alt="폴더버거 핫치킨"></div>
                        <div class="i103">5,700원</div>
                    </div>
                    <div class="item2">
                        <div class="i101">폴더버거 비프</div>
                        <div class="i102"><img src="http://www.lotteria.com//Data//Goods/327/DetailImage.jpg" alt="폴더버거 비프"></div>
                        <div class="i103">5,700원</div>
                    </div>
                    <div class="item3">
                        <div class="i101">리아미라클버거</div>
                        <div class="i102"><img src="http://www.lotteria.com//Data//Goods/318/DetailImage.jpg" alt="리아미라클버거"></div>
                        <div class="i103">5,600원</div>
                    </div>
                    <div class="item4">
                        <div class="i101">원조 빅불</div>
                        <div class="i102"><img src="http://www.lotteria.com//Data//Goods/143/DetailImage.jpg" alt="원조 빅불"></div>
                        <div class="i103">5,800원</div>
                    </div> 
                </div>
                <div class="main">
                    <div class="item1">
                        <div class="i101">와규 에디션Ⅱ</div>
                        <div class="i102"><img src="http://www.lotteria.com//Data//Goods/306/DetailImage.jpg" alt="와규 에디션Ⅱ"></div>
                        <div class="i103">5,800원</div>
                    </div>
                    <div class="item2">
                        <div class="i101">더블X2</div>
                        <div class="i102"><img src="http://www.lotteria.com//Data//Goods/299/DetailImage.jpg" alt="더블X2"></div>
                        <div class="i103">5,500원</div>
                    </div>
                    <div class="item3">
                        <div class="i101">새우버거</div>
                        <div class="i102"><img src="http://www.lotteria.com//Data//Goods/296/DetailImage.jpg" alt="새우버거"></div>
                        <div class="i103">3,900원</div>
                    </div>
                    <div class="item4">
                        <div class="i101">핫크리스피버거</div>
                        <div class="i102"><img src="http://www.lotteria.com//Data//Goods/100/DetailImage.jpg" alt="핫크리스피버거"></div>
                        <div class="i103">4,900원</div>
                    </div>
                </div>
                <br>
                </li>
                <li>
                <br>
                <div class="main">
                    <div class="item1">
                            <div class="i101">치킨버거</div>
                            <div class="i102"><img src="http://www.lotteria.com//Data//Goods/294/DetailImage.jpg" alt="치킨버거"></div>
                            <div class="i103">2,900원</div>
                        </div> 
                        <div class="item2">
                            <div class="i101">T-Rex</div>
                            <div class="i102"><img src="http://www.lotteria.com//Data//Goods/290/DetailImage.jpg" alt="T-Rex"></div>
                            <div class="i103">3,700원</div>
                        </div>
                        <div class="item3">
                            <div class="i101">클래식 치즈버거</div>
                            <div class="i102"><img src="http://www.lotteria.com//Data//Goods/238/DetailImage.jpg" alt="클래식 치즈버거"></div>
                            <div class="i103">4,400원</div>
                        </div>
                        <div class="item4">
                            <div class="i101">불고기버거</div>
                            <div class="i102"><img src="http://www.lotteria.com//Data//Goods/68/DetailImage.jpg" alt="불고기버거"></div>
                            <div class="i103">3,900원</div>
                        </div>
                    </div>
                    <br>
                    <div class="main">
                        <div class="item1">
                            <div class="i101">한우불고기</div>
                            <div class="i102"><img src="http://www.lotteria.com//Data//Goods/233/DetailImage.jpg" alt="한우불고기"></div>
                            <div class="i103">7,000원</div>
                        </div>
                        <div class="item2">
                            <div class="i101">모짜렐라 인 더 버거</div>
                            <div class="i102"><img src="http://www.lotteria.com//Data//Goods/231/DetailImage.jpg" alt="모짜렐라 인 더 버거"></div>
                            <div class="i103">6,000원</div>
                        </div>
                        <div class="item3">
                            <div class="i101">AZ버거</div>
                            <div class="i102"><img src="http://www.lotteria.com//Data//Goods/219/DetailImage.jpg" alt="AZ버거"></div>
                            <div class="i103">6,600원</div>
                        </div>
                        <div class="item4">
                            <div class="i101">데리버거</div>
                            <div class="i102"><img src="http://www.lotteria.com//Data//Goods/26/DetailImage.jpg" alt="데리버거"></div>
                            <div class="i103">2,500원</div>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
        <div class="side">
            <div class="주문">
                주문하실 버거의<br>
                이름과 수량을<br>
                말씀해주세요
            </div>
            <div class="select">
                <br>선택하신 버거
            </div>
            <br>
            <table id="orderlist" width="300px">
                <br>
                <tr><div class="button"><button type="button" onclick="location.href='/popup.html'">결제</button></div></tr>
                <tr><th class="select_name">메뉴 이름</th><th class="ea">수량</th><tr>
            </table>
        </div>
       
    </section>

    <script>
        var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition;
        var SpeechGrammarList = SpeechGrammarList || webkitSpeechGrammarList;
        var speechlist = new Array();

        {% comment %} csrf token 추가 {% endcomment %}
        var token = '{{csrf_token}}'; 

        var grammar = '#JSGF V1.0; grammar menus; public <menu> = 폴더 | 버거 | 폴더버거 | 핫치킨 | 폴더버거 핫치킨 | 폴더버거핫치킨 | 비프 | 리아미라 | 클버거 | 빅불 | 치킨 | 와규 | 더블 | 새우버거 | 핫크리스피 | 티렉스 | 클래식 | 치즈버거 | 새우버거 | 불고기버거 | 한우불고기 | 모짜렐라 | 인더버거 | 모짜렐라인더버거 | AZ | 데리버거 | 버거 ;'
        
        var recognition = new SpeechRecognition();
        var speechRecognitionList = new SpeechGrammarList();
        speechRecognitionList.addFromString(grammar, 1.1);
        
        recognition.grammars = speechRecognitionList

        recognition.continuous = false; 
        recognition.lang = 'ko-kr';

        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        {% comment %} 서버에서 가져온 메뉴 dictionary를 od에 저장 {% endcomment %}
        var od = {};
        {% for key in orderdict.keys %}
            od['{{ key }}'] = 0
        {% endfor %}


        console.log("가져온 딕셔너리: ", od);
        console.log('새우버거 수량:', od['새우버거']);
        console.log('폴더버거 비프 수량:', od['폴더버거 비프']);
        console.log('원조 빅불 수량:', od['원조 빅불']);

        var diagnostic = document.querySelector('.output');
        var bg = document.querySelector('html');

        {% comment %} 음성인식 시작 {% endcomment %}
        document.body.onload = function() {
            recognition.start();
            console.log('주문할 내용을 말해주세요.');
        }

        recognition.onresult = function(event) {
            var last = event.results[0][0].transcript;
            speechlist.push(last);
            console.log("인식 내용 : ", last)
            console.log("서버에서 인식 중입니다...")

            if (last.search('결제') != -1){
                window.location.href='/popup.html'
            }

            {% comment %} 서버로 음성인식된 단어 보내기 {% endcomment %}
            $.ajax({
                headers: { "X-CSRFToken": token },
                url: "{% url 'getorder' %}",
                type: "POST",
                data: {
                    getdata: last
                },
                
                success: function(result){
                    console.log("서버 처리 후 메뉴 : ", result.message)
                    od[result.message] = od[result.message] + 1
                    console.log("메뉴", result.message, "의 수량이", od[result.message]-1, "에서", od[result.message], "로 증가")

                    {% comment %} temp에 메뉴가 들어가 있는 요소들 중 찾고자 하는 메뉴가 있는지 체크하여 경로 저장. 없으면 undefined 반환 {% endcomment %}
                    var temp = $("#orderlist > tbody > tr > td:nth-child(2n-1):contains('" + result.message + "')");

                    {% comment %} temp[0]에 undifined가 있으면 해당 요소의 html부분 바꾸기. 그 외에는 메뉴가 없다는 것이므로 append를 이용해 새로운 메뉴 row를 추가시켜준다.{% endcomment %}
                    console.log("temp", temp[0]);
                    if (temp[0] != undefined){
                        {% comment %} newtemp = temp.parent(); {% endcomment %}
                        $(temp.parent().children('td.ea')).html(od[result.message]);
                    }
                    else{
                        $('#orderlist').append('<tr><td class="select_name">'+result.message+"&nbsp;"+'<br>'+'</td> <td class="ea">1</td> <tr>');
                    }
                },
                error: function(e){
                    console.log('error:', e.status);
                },
            })
        }

        recognition.onend = function(event) {
            recognition.start();
        };
        
        recognition.onerror = function(event) {
            message.textContent = 'Error occured in recognition: ' + event.error;
        }
    </script>
</body>
</html>
